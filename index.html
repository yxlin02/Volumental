<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Foot Measurement</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family: -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial,
          "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
          sans-serif;
        background: #fff;
      }
      .wrap {
        max-width: 600px;
        margin: 0 auto;
        padding: 24px 16px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .email-form {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
      }
      .email-form label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
        font-size: 16px;
      }
      .email-form input {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .email-form .note {
        margin-top: 8px;
        font-size: 14px;
        color: #666;
      }
      .email-form .error-message {
        margin-top: 8px;
        font-size: 14px;
        color: #d32f2f;
        display: none;
      }
      .email-form .error-message.show {
        display: block;
      }
      .email-form .confirm-btn {
        width: 100%;
        padding: 12px;
        margin-top: 12px;
        font-size: 16px;
        font-weight: bold;
        color: white;
        background: #007acc;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .email-form .confirm-btn:hover {
        background: #005a9e;
      }
      .email-form .confirm-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .email-form .email-confirmed {
        margin-top: 12px;
        padding: 10px;
        background: #e8f5e9;
        border: 1px solid #4caf50;
        border-radius: 4px;
        color: #2e7d32;
        font-size: 14px;
      }
      .email-form .email-confirmed span {
        font-weight: bold;
      }
      .scan-button-container {
        text-align: center;
        position: relative;
      }
      .scan-button-container.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .scan-button-container .disabled-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        font-size: 14px;
        color: #666;
        z-index: 10;
      }
      .scan-button-container.disabled .disabled-overlay {
        display: flex;
      }
      /* è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ */
      #debug-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-height: 40vh;
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: "Courier New", monospace;
        font-size: 12px;
        padding: 12px;
        overflow-y: auto;
        z-index: 10000;
        border-top: 2px solid #007acc;
        display: none; /* é»˜è®¤éšè—ï¼Œå¯ä»¥é€šè¿‡æŒ‰é’®åˆ‡æ¢ */
      }
      #debug-panel.show {
        display: block;
      }
      #debug-panel .debug-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #444;
      }
      #debug-panel .debug-title {
        font-weight: bold;
        color: #4ec9b0;
        font-size: 14px;
      }
      #debug-panel .debug-controls {
        display: flex;
        gap: 8px;
      }
      #debug-panel button {
        background: #007acc;
        color: white;
        border: none;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
      }
      #debug-panel button:hover {
        background: #005a9e;
      }
      #debug-panel .debug-content {
        max-height: calc(40vh - 60px);
        overflow-y: auto;
      }
      #debug-panel .debug-log {
        margin: 4px 0;
        padding: 4px 8px;
        border-left: 3px solid transparent;
        word-wrap: break-word;
        white-space: pre-wrap;
      }
      #debug-panel .debug-log.log {
        border-left-color: #4ec9b0;
      }
      #debug-panel .debug-log.warn {
        border-left-color: #dcdcaa;
        background: rgba(220, 220, 170, 0.1);
      }
      #debug-panel .debug-log.error {
        border-left-color: #f48771;
        background: rgba(244, 135, 113, 0.1);
      }
      #debug-toggle {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: #007acc;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        z-index: 10001;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      #debug-toggle:hover {
        background: #005a9e;
      }
    </style>
  </head>
  <body>
    <!-- Volumental Measurement Widget -->

    <div class="wrap">
      <h2 style="margin-top: 0; text-align: center">Foot Measurement</h2>

      <form class="email-form" id="emailForm" novalidate>
        <label for="emailInput">Email Address *</label>
        <input
          type="email"
          id="emailInput"
          name="email-address"
          placeholder="your.email@example.com"
          required
          autocomplete="email"
        />
        <div class="note">
          Please enter your email and click "Confirm" to start the measurement.
        </div>
        <div class="error-message" id="emailError">
          Please enter a valid email address to start scanning.
        </div>
        <button type="submit" id="confirmEmailBtn" class="confirm-btn">
          Confirm Email
        </button>
        <div class="email-confirmed" id="emailConfirmed" style="display: none">
          âœ“ Email confirmed: <span id="confirmedEmailText"></span>
        </div>
      </form>

      <div class="scan-button-container" id="scanButtonContainer">
        <div class="disabled-overlay">
          Please enter your email address first
        </div>
        <volumental-measurement
          id="volumental-widget"
          variant="outline"
          measurement-on-widget="true"
        ></volumental-measurement>
      </div>
    </div>

    <!-- è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
    <button id="debug-toggle">ğŸ” Debug</button>
    <div id="debug-panel">
      <div class="debug-header">
        <div class="debug-title">ğŸ“± Debug Console</div>
        <div class="debug-controls">
          <button onclick="clearDebugLog()">Clear</button>
          <button onclick="toggleDebugPanel()">Hide</button>
        </div>
      </div>
      <div class="debug-content" id="debug-content"></div>
    </div>

    <script>
      // è°ƒè¯•é¢æ¿åŠŸèƒ½
      function addDebugLog(message, type = "log") {
        const debugContent = document.getElementById("debug-content");
        const logDiv = document.createElement("div");
        logDiv.className = `debug-log ${type}`;

        const timestamp = new Date().toLocaleTimeString();
        const prefix = type === "error" ? "âŒ" : type === "warn" ? "âš ï¸" : "â„¹ï¸";
        logDiv.textContent = `[${timestamp}] ${prefix} ${message}`;

        debugContent.appendChild(logDiv);
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        debugContent.scrollTop = debugContent.scrollHeight;

        // é™åˆ¶æ—¥å¿—æ•°é‡ï¼Œé¿å…å†…å­˜é—®é¢˜
        const maxLogs = 200;
        while (debugContent.children.length > maxLogs) {
          debugContent.removeChild(debugContent.firstChild);
        }
      }

      function clearDebugLog() {
        document.getElementById("debug-content").innerHTML = "";
        addDebugLog("Debug log cleared", "log");
      }

      function toggleDebugPanel() {
        const panel = document.getElementById("debug-panel");
        panel.classList.toggle("show");
        const button = document.getElementById("debug-toggle");
        button.textContent = panel.classList.contains("show")
          ? "ğŸ” Hide"
          : "ğŸ” Debug";
      }

      // åˆå§‹åŒ–è°ƒè¯•é¢æ¿
      document
        .getElementById("debug-toggle")
        .addEventListener("click", toggleDebugPanel);

      // æ‹¦æˆª console æ–¹æ³•
      const originalLog = console.log;
      const originalWarn = console.warn;
      const originalError = console.error;

      console.log = function (...args) {
        originalLog.apply(console, args);
        const message = args
          .map((arg) => {
            if (typeof arg === "object") {
              try {
                return JSON.stringify(arg, null, 2);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          })
          .join(" ");
        addDebugLog(message, "log");
      };

      console.warn = function (...args) {
        originalWarn.apply(console, args);
        const message = args
          .map((arg) => {
            if (typeof arg === "object") {
              try {
                return JSON.stringify(arg, null, 2);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          })
          .join(" ");
        addDebugLog(message, "warn");
      };

      console.error = function (...args) {
        originalError.apply(console, args);
        const message = args
          .map((arg) => {
            if (typeof arg === "object") {
              try {
                return JSON.stringify(arg, null, 2);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          })
          .join(" ");
        addDebugLog(message, "error");
      };

      // é¡µé¢åŠ è½½å®Œæˆæç¤º
      addDebugLog("Debug console initialized", "log");

      // å…è®¸ autofillï¼Œä½†ç¡®ä¿èƒ½æ­£ç¡®è¯»å– autofill çš„å€¼
      // ç›‘å¬ autofill å®Œæˆäº‹ä»¶ï¼Œç¡®ä¿å€¼è¢«æ­£ç¡®è¯»å–
      const emailInput = document.getElementById("emailInput");
      if (emailInput) {
        // ç›‘å¬ autocomplete äº‹ä»¶ï¼ˆæŸäº›æµè§ˆå™¨ä¼šè§¦å‘ï¼‰
        emailInput.addEventListener("autocomplete", function (e) {
          addDebugLog(
            "Autocomplete detected, email value: " + emailInput.value,
            "log"
          );
          // è§¦å‘éªŒè¯ï¼Œç¡®ä¿æŒ‰é’®çŠ¶æ€æ›´æ–°
          if (emailInput.dispatchEvent) {
            emailInput.dispatchEvent(new Event("input", { bubbles: true }));
          }
        });

        // ç›‘å¬ input äº‹ä»¶ï¼Œç¡®ä¿ autofill çš„å€¼è¢«æ­£ç¡®æ•è·
        emailInput.addEventListener("input", function (e) {
          addDebugLog("Email input changed: " + emailInput.value, "log");
        });

        // ç›‘å¬ change äº‹ä»¶ï¼ˆautofill é€šå¸¸ä¼šè§¦å‘ change äº‹ä»¶ï¼‰
        emailInput.addEventListener("change", function (e) {
          addDebugLog(
            "Email changed (possibly autofill): " + emailInput.value,
            "log"
          );
        });

        // å»¶è¿Ÿæ£€æŸ¥ autofillï¼ˆæŸäº›æµè§ˆå™¨åœ¨é¡µé¢åŠ è½½åæ‰ä¼šå¡«å……ï¼‰
        setTimeout(function () {
          if (emailInput.value) {
            addDebugLog(
              "Detected autofilled email: " + emailInput.value,
              "log"
            );
            // è§¦å‘éªŒè¯ï¼Œç¡®ä¿æŒ‰é’®çŠ¶æ€æ›´æ–°
            if (emailInput.dispatchEvent) {
              emailInput.dispatchEvent(new Event("input", { bubbles: true }));
            }
          }
        }, 500);
      }

      // å¤„ç†è¡¨å•æäº¤ï¼Œç¡®è®¤ email
      const emailForm = document.getElementById("emailForm");
      if (emailForm) {
        emailForm.addEventListener("submit", function (e) {
          e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡¨å•æäº¤

          const emailInput = document.getElementById("emailInput");
          const emailError = document.getElementById("emailError");
          const emailConfirmed = document.getElementById("emailConfirmed");
          const confirmedEmailText =
            document.getElementById("confirmedEmailText");
          const confirmBtn = document.getElementById("confirmEmailBtn");

          if (!emailInput) return;

          const email = emailInput.value ? emailInput.value.trim() : "";

          // éªŒè¯ email æ ¼å¼
          if (!email) {
            emailError.textContent = "Please enter your email address.";
            emailError.classList.add("show");
            addDebugLog("Email is empty", "error");
            return;
          }

          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailPattern.test(email)) {
            emailError.textContent = "Please enter a valid email address.";
            emailError.classList.add("show");
            addDebugLog("Invalid email format: " + email, "error");
            return;
          }

          // Email æœ‰æ•ˆï¼Œç¡®è®¤å¹¶ä¿å­˜
          confirmedEmail = email;
          emailError.classList.remove("show");
          emailConfirmed.style.display = "block";
          confirmedEmailText.textContent = email;
          confirmBtn.disabled = true;
          confirmBtn.textContent = "âœ“ Email Confirmed";

          // ä¿å­˜åˆ° localStorage
          localStorage.setItem("volumental_email", email);

          addDebugLog("Email confirmed: " + email, "log");
          console.log("[Volumental] âœ… Email å·²ç¡®è®¤:", email);

          // æ›´æ–°æ‰«ææŒ‰é’®çŠ¶æ€ï¼ˆé€šè¿‡è§¦å‘ input äº‹ä»¶ï¼‰
          emailInput.dispatchEvent(new Event("input", { bubbles: true }));
        });
      }

      const LOG_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbzNSJAJ6JAO2Cx8m3wzev0DYXWYcXrUyIVMdSbW6BOiB4LP46BW5Rsyut9qT_qn9zE0/exec";
      const SDK_URL = "https://js.volumental.com/sdk/v1/volumental.js";
      const CLIENT_ID = "f5b24fb9-1881-4998-a641-9f840056dcdd";

      console.log("[Volumental] å¼€å§‹åŠ è½½ SDK...", { SDK_URL, CLIENT_ID });

      // é˜²é‡å¤æäº¤ï¼šè®°å½•å·²å‘é€çš„ scanId
      const sentScanIds = new Set();
      let isListenerSetup = false;
      // è·Ÿè¸ªå½“å‰æ‰«æä¼šè¯ï¼šè®°å½•æ‰«æå¼€å§‹æ—¶çš„ scanIdï¼Œç¡®ä¿åªä¸Šä¼ æœ¬æ¬¡æ‰«æçš„ scanId
      let currentScanSessionId = null;
      let isScanInProgress = false;
      // è®°å½• widget æ‰“å¼€çš„æ—¶é—´æˆ³ï¼Œç”¨äºè¿‡æ»¤ç¼“å­˜çš„æ—§ scanId
      let widgetOpenedTimestamp = null;
      // åœ¨ widget æ‰“å¼€åçš„è¿™ä¸ªæ—¶é—´çª—å£å†…ï¼ˆæ¯«ç§’ï¼‰ï¼Œå¿½ç•¥æ‰€æœ‰ measurement äº‹ä»¶ï¼ˆå¯èƒ½æ˜¯ç¼“å­˜çš„ï¼‰
      const CACHE_IGNORE_WINDOW_MS = 3000; // 3 ç§’
      // å·²ç¡®è®¤çš„ emailï¼ˆé€šè¿‡è¡¨å•æäº¤ç¡®è®¤ï¼‰
      let confirmedEmail = null;

      // è·å– email çš„è¾…åŠ©å‡½æ•°ï¼ˆä»å¤šä¸ªæ¥æºè·å–ï¼‰
      function getEmail() {
        // 1. ä¼˜å…ˆä½¿ç”¨å·²ç¡®è®¤çš„ emailï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        if (confirmedEmail) {
          console.log("[Volumental] ä½¿ç”¨å·²ç¡®è®¤çš„ email:", confirmedEmail);
          return confirmedEmail;
        }

        // 2. ä» email è¾“å…¥æ¡†è·å–
        const emailInput = document.getElementById("emailInput");
        if (emailInput && emailInput.value.trim()) {
          const email = emailInput.value.trim();
          console.log("[Volumental] ä»è¾“å…¥æ¡†è·å– email:", email);
          return email;
        }

        // 3. ä» URL å‚æ•°è·å–
        const urlParams = new URLSearchParams(window.location.search);
        const urlEmail = urlParams.get("email");
        if (urlEmail) {
          console.log("[Volumental] ä» URL å‚æ•°è·å– email:", urlEmail);
          return urlEmail;
        }

        // 4. ä» localStorage è·å–
        const storedEmail = localStorage.getItem("volumental_email");
        if (storedEmail) {
          console.log("[Volumental] ä» localStorage è·å– email:", storedEmail);
          return storedEmail;
        }

        // 5. å¦‚æœéƒ½æ²¡æœ‰ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        console.log("[Volumental] æœªæ‰¾åˆ° emailï¼Œå°†ä½¿ç”¨ç©ºå€¼");
        return "";
      }

      // åŠ è½½ SDK
      (function loadSdk() {
        const s = document.createElement("script");
        s.async = true;
        s.src = SDK_URL;
        s.setAttribute("data-client-id", CLIENT_ID);
        s.onload = () => {
          console.log("[Volumental] SDK è„šæœ¬æ–‡ä»¶åŠ è½½æˆåŠŸ");
        };
        s.onerror = () => {
          console.error("[Volumental] SDK è„šæœ¬åŠ è½½å¤±è´¥");
        };
        document.body.appendChild(s);
      })();

      // ç­‰å¾… SDK åŠ è½½å®Œæˆåè®¾ç½®äº‹ä»¶ç›‘å¬ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
      window.addEventListener("volumental:on-loaded", () => {
        // é˜²æ­¢é‡å¤è®¾ç½®ç›‘å¬å™¨
        if (isListenerSetup) {
          console.warn("[Volumental] âš ï¸ äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®ï¼Œè·³è¿‡é‡å¤è®¾ç½®");
          return;
        }
        isListenerSetup = true;
        console.log("[Volumental] SDK åˆå§‹åŒ–å®Œæˆï¼Œwindow.Volumental å·²å¯ç”¨");

        // æ‰¾åˆ° widget å…ƒç´ 
        const element = document.getElementById("volumental-widget");
        if (!element) {
          console.error("[Volumental] âŒ æ‰¾ä¸åˆ° volumental-measurement å…ƒç´ ");
          return;
        }

        // è·å– emailï¼ˆä¸å†è®¾ç½® subjectï¼Œæ ¹æ®æ–‡æ¡£é»˜è®¤æ˜¯ undefinedï¼‰
        const email = getEmail();

        console.log("[Volumental] âœ… æ‰¾åˆ° widget å…ƒç´ ï¼Œå¼€å§‹è®¾ç½®äº‹ä»¶ç›‘å¬å™¨");

        // Email éªŒè¯å‡½æ•°
        function isValidEmail(email) {
          if (!email || typeof email !== "string") return false;
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailPattern.test(email.trim());
        }

        // æ›´æ–°æ‰«ææŒ‰é’®çŠ¶æ€
        function updateScanButtonState() {
          const emailInput = document.getElementById("emailInput");
          const scanButtonContainer = document.getElementById(
            "scanButtonContainer"
          );
          const emailError = document.getElementById("emailError");

          if (!emailInput || !scanButtonContainer) return;

          // ä¼˜å…ˆä½¿ç”¨å·²ç¡®è®¤çš„ email
          const email =
            confirmedEmail || (emailInput.value ? emailInput.value.trim() : "");
          const isValid = isValidEmail(email);

          // åªæœ‰åœ¨ email å·²ç¡®è®¤ä¸”æœ‰æ•ˆæ—¶æ‰å¯ç”¨æ‰«ææŒ‰é’®
          if (confirmedEmail && isValid) {
            scanButtonContainer.classList.remove("disabled");
            emailError.classList.remove("show");
            console.log("[Volumental] âœ… Email å·²ç¡®è®¤ä¸”æœ‰æ•ˆï¼Œæ‰«ææŒ‰é’®å·²å¯ç”¨");
          } else {
            scanButtonContainer.classList.add("disabled");
            if (email.length > 0 && !confirmedEmail) {
              emailError.classList.remove("show");
            } else if (email.length > 0 && !isValid) {
              emailError.classList.add("show");
            } else {
              emailError.classList.remove("show");
            }
            console.log("[Volumental] âš ï¸ Email æœªç¡®è®¤æˆ–æ— æ•ˆï¼Œæ‰«ææŒ‰é’®å·²ç¦ç”¨");
          }
        }

        // ç›‘å¬ email è¾“å…¥æ¡†å˜åŒ–
        const emailInput = document.getElementById("emailInput");
        if (emailInput) {
          emailInput.addEventListener("input", updateScanButtonState);
          emailInput.addEventListener("blur", updateScanButtonState);
          emailInput.addEventListener("change", updateScanButtonState);
        }

        // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        updateScanButtonState();

        // ç›‘å¬ widget æ‰“å¼€äº‹ä»¶ - åœ¨æ‰“å¼€æ—¶éªŒè¯ email å¹¶é‡ç½®æ‰«æä¼šè¯
        element.addEventListener("volumental:on-opened", (e) => {
          console.log("[Volumental] ğŸ“± æ‰«æç•Œé¢å·²æ‰“å¼€");

          // é‡ç½®æ‰«æä¼šè¯ï¼šæ¸…é™¤ä¹‹å‰çš„ scanIdï¼Œæ ‡è®°æ–°çš„æ‰«æå¼€å§‹
          currentScanSessionId = null;
          isScanInProgress = true;
          // è®°å½•æ‰“å¼€æ—¶é—´æˆ³ï¼Œç”¨äºè¿‡æ»¤ç¼“å­˜çš„æ—§ scanId
          widgetOpenedTimestamp = Date.now();
          console.log(
            "[Volumental] ğŸ”„ æ–°çš„æ‰«æä¼šè¯å¼€å§‹ï¼Œå·²æ¸…é™¤ä¹‹å‰çš„ scanIdï¼Œæ—¶é—´æˆ³:",
            widgetOpenedTimestamp
          );

          // å†æ¬¡éªŒè¯ email
          const emailInput = document.getElementById("emailInput");
          const email = emailInput ? emailInput.value.trim() : "";

          if (!isValidEmail(email)) {
            console.warn("[Volumental] âš ï¸ Email æ— æ•ˆï¼Œé˜»æ­¢æ‰«æ");
            addDebugLog(
              "Email is required. Please enter your email address first.",
              "error"
            );

            // æ˜¾ç¤ºé”™è¯¯æç¤º
            const emailError = document.getElementById("emailError");
            if (emailError) {
              emailError.classList.add("show");
              emailError.textContent =
                "Please enter a valid email address to start scanning.";
            }

            // æ»šåŠ¨åˆ° email è¾“å…¥æ¡†
            if (emailInput) {
              emailInput.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
              emailInput.focus();
            }

            // é‡ç½®æ‰«æçŠ¶æ€
            isScanInProgress = false;
            currentScanSessionId = null;
          }
        });

        // ç›‘å¬ widget å…³é—­äº‹ä»¶
        element.addEventListener("volumental:on-closed", () => {
          console.log("[Volumental] ğŸ“± æ‰«æç•Œé¢å·²å…³é—­");
          // å¦‚æœæ‰«ææœªå®Œæˆå°±å…³é—­ï¼Œé‡ç½®çŠ¶æ€
          if (isScanInProgress && !currentScanSessionId) {
            console.log("[Volumental] ğŸ”„ æ‰«æè¢«å–æ¶ˆï¼Œé‡ç½®çŠ¶æ€");
            isScanInProgress = false;
            currentScanSessionId = null;
          }
          // æ¸…é™¤æ—¶é—´æˆ³
          widgetOpenedTimestamp = null;
        });

        // ç›‘å¬é”™è¯¯äº‹ä»¶
        element.addEventListener("volumental:on-error", (e) => {
          console.error(
            "[Volumental] âŒ æ‰«æé”™è¯¯:",
            e.detail?.message || "æœªçŸ¥é”™è¯¯"
          );
        });

        // æ ¹æ®æ–‡æ¡£ï¼Œåœ¨å…ƒç´ ä¸Šä½¿ç”¨ addEventListener ç›‘å¬äº‹ä»¶
        element.addEventListener("volumental:on-measurement", (e) => {
          console.log("[Volumental] âœ… æ‰«æå®Œæˆï¼äº‹ä»¶å·²è§¦å‘", e.detail);

          // æ ¹æ®æ–‡æ¡£ï¼Œæ•°æ®åœ¨ e.detail ä¸­ï¼ŒåŒ…å« { id } å­—æ®µ
          const scanId = e.detail?.id || "";

          // éªŒè¯ scanId
          if (!scanId) {
            console.warn("[Volumental] âš ï¸ scanId ä¸ºç©ºï¼Œè·³è¿‡å‘é€");
            return;
          }

          // å‰ç«¯æ£€æŸ¥ 1ï¼šå¦‚æœè¿™ä¸ª scanId å·²ç»å‘é€è¿‡ï¼ˆåŒä¸€é¡µé¢ä¼šè¯ä¸­ï¼‰ï¼Œç›´æ¥å¿½ç•¥
          if (sentScanIds.has(scanId)) {
            console.warn(
              "[Volumental] âš ï¸ scanId å·²åœ¨æœ¬é¡µé¢ä¼šè¯ä¸­å‘é€è¿‡ï¼Œè·³è¿‡:",
              scanId
            );
            addDebugLog(`Ignoring already sent scanId ${scanId}`, "warn");
            return;
          }

          // å‰ç«¯æ£€æŸ¥ 2ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯ç¼“å­˜çš„æ—§ scanIdï¼ˆåœ¨ widget æ‰“å¼€åçš„çŸ­æ—¶é—´å†…è§¦å‘ï¼‰
          const now = Date.now();
          if (
            widgetOpenedTimestamp &&
            now - widgetOpenedTimestamp < CACHE_IGNORE_WINDOW_MS
          ) {
            console.warn(
              "[Volumental] âš ï¸ æ£€æµ‹åˆ°ç¼“å­˜çš„æ—§ scanIdï¼ˆåœ¨æ‰“å¼€å",
              now - widgetOpenedTimestamp,
              "ms å†…è§¦å‘ï¼‰ï¼Œè·³è¿‡:",
              scanId
            );
            addDebugLog(
              `Ignoring cached scanId ${scanId} (triggered ${
                now - widgetOpenedTimestamp
              }ms after widget opened)`,
              "warn"
            );
            return;
          }

          // å‰ç«¯æ£€æŸ¥ 3ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„æ‰«æä¼šè¯
          if (!isScanInProgress) {
            console.warn("[Volumental] âš ï¸ æ²¡æœ‰è¿›è¡Œä¸­çš„æ‰«æä¼šè¯ï¼Œè·³è¿‡:", scanId);
            return;
          }

          // å‰ç«¯æ£€æŸ¥ 4ï¼šè®°å½•æœ¬æ¬¡ä¼šè¯çš„ scanIdï¼ˆç”¨äºåç»­éªŒè¯ï¼‰
          if (!currentScanSessionId) {
            currentScanSessionId = scanId;
            console.log("[Volumental] ğŸ“ è®°å½•æœ¬æ¬¡æ‰«æä¼šè¯çš„ scanId:", scanId);
          } else if (currentScanSessionId !== scanId) {
            // å¦‚æœ scanId ä¸æœ¬æ¬¡ä¼šè¯çš„ä¸ä¸€è‡´ï¼Œè·³è¿‡
            console.warn(
              "[Volumental] âš ï¸ scanId ä¸æœ¬æ¬¡ä¼šè¯ä¸ä¸€è‡´ï¼Œè·³è¿‡:",
              scanId,
              "å½“å‰ä¼šè¯ scanId:",
              currentScanSessionId
            );
            return;
          }

          // æ³¨æ„ï¼šåç«¯ä¼šè¿›è¡Œæœ€ç»ˆæ£€æŸ¥ï¼ˆæ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å·²å­˜åœ¨ scanIdï¼‰
          // å¦‚æœåç«¯è¿”å› skipped: trueï¼Œè¯´æ˜ scanId å·²å­˜åœ¨äºæ•°æ®åº“ä¸­

          // åªä½¿ç”¨å·²ç¡®è®¤çš„ emailï¼ˆå¿…é¡»ç‚¹å‡» confirm æŒ‰é’®ï¼‰
          const email = confirmedEmail;

          // è®°å½• email çŠ¶æ€
          console.log("[Volumental] ğŸ“§ confirmedEmail:", confirmedEmail);
          console.log(
            "[Volumental] ğŸ“§ è¾“å…¥æ¡†å€¼:",
            document.getElementById("emailInput")?.value
          );

          // æ£€æŸ¥ email æ˜¯å¦å·²ç¡®è®¤
          if (!email || !isValidEmail(email)) {
            console.error("[Volumental] âŒ Email æœªç¡®è®¤æˆ–æ— æ•ˆï¼Œæ— æ³•å‘é€æ•°æ®");
            addDebugLog(
              "Cannot send data: Please confirm your email address first.",
              "error"
            );

            // æ˜¾ç¤ºé”™è¯¯æç¤º
            const emailError = document.getElementById("emailError");
            if (emailError) {
              emailError.classList.add("show");
              emailError.textContent =
                "Please confirm your email address before scanning. Data was not sent.";
            }

            // æ»šåŠ¨åˆ° email è¾“å…¥æ¡†
            const emailInput = document.getElementById("emailInput");
            if (emailInput) {
              emailInput.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
              emailInput.focus();
            }

            // é‡ç½®æ‰«æçŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·é‡æ–°æ‰«æ
            isScanInProgress = false;
            currentScanSessionId = null;
            console.log("[Volumental] ğŸ”„ Email æœªç¡®è®¤ï¼Œé‡ç½®æ‰«æçŠ¶æ€");

            return; // ä¸å‘é€æ•°æ®
          }

          console.log("[Volumental] ğŸ“§ æœ€ç»ˆä½¿ç”¨çš„ email:", email);
          console.log("[Volumental] æå–çš„æ•°æ®:", { scanId, email });

          const payload = {
            email: email, // ç¡®ä¿ email å­—æ®µå­˜åœ¨ä¸”æœ‰æ•ˆ
            scanId: scanId,
            userAgent: navigator.userAgent,
            locale: navigator.language || "",
            extra: e.detail || {},
          };

          console.log("[Volumental] ğŸ“¤ å‡†å¤‡å‘é€æ•°æ®åˆ° Apps Script");
          console.log(
            "[Volumental] å®Œæ•´ payload:",
            JSON.stringify(payload, null, 2)
          );
          console.log("[Volumental] Email å­—æ®µå€¼:", payload.email);
          console.log("[Volumental] Email å­—æ®µç±»å‹:", typeof payload.email);
          console.log(
            "[Volumental] Email å­—æ®µé•¿åº¦:",
            payload.email ? payload.email.length : 0
          );
          console.log(
            "[Volumental] Email æ˜¯å¦ä¸ºç©º:",
            !payload.email || payload.email === ""
          );
          console.log("[Volumental] ç›®æ ‡ URL:", LOG_ENDPOINT);

          // éªŒè¯ payload ä¸­çš„ email å­—æ®µ
          const payloadString = JSON.stringify(payload);
          console.log("[Volumental] åºåˆ—åŒ–åçš„ JSON å­—ç¬¦ä¸²:", payloadString);
          console.log(
            "[Volumental] JSON ä¸­æ˜¯å¦åŒ…å« email å­—æ®µ:",
            payloadString.includes('"email"')
          );

          // éªŒè¯ email åœ¨ JSON ä¸­çš„ä½ç½®
          const emailIndex = payloadString.indexOf('"email"');
          if (emailIndex !== -1) {
            const emailValueStart = payloadString.indexOf(":", emailIndex) + 1;
            const emailValueEnd = payloadString.indexOf(",", emailValueStart);
            const emailInJson = payloadString.substring(
              emailValueStart,
              emailValueEnd !== -1
                ? emailValueEnd
                : payloadString.indexOf("}", emailValueStart)
            );
            console.log("[Volumental] JSON ä¸­çš„ email å€¼:", emailInJson.trim());
          }

          // ä½¿ç”¨å·²ç¡®è®¤çš„ emailï¼ˆå·²é€šè¿‡éªŒè¯ï¼‰
          // æœ€ç»ˆç¡®è®¤ email å€¼
          console.log("[Volumental] ğŸ“§ æœ€ç»ˆå‘é€çš„ email å€¼:", payload.email);
          console.log(
            "[Volumental] ğŸ“§ Email æ˜¯å¦ä¸ºç©º:",
            !payload.email || payload.email === ""
          );

          // æ ‡è®°ä¸ºå·²å‘é€ï¼ˆåœ¨å‘é€å‰æ ‡è®°ï¼Œé˜²æ­¢å¹¶å‘è¯·æ±‚ï¼‰
          sentScanIds.add(scanId);

          // å‘é€æ•°æ®åˆ° Apps Script
          fetch(LOG_ENDPOINT, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => {
              console.log("[Volumental] ğŸ“¥ æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :", res.status);
              return res.json();
            })
            .then((result) => {
              console.log(
                "[Volumental] âœ… æ•°æ®å‘é€æˆåŠŸï¼Apps Script å“åº”:",
                result
              );

              // æ£€æŸ¥åç«¯æ˜¯å¦è¿”å› skippedï¼ˆscanId å·²å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼‰
              if (result && result.skipped) {
                console.warn(
                  "[Volumental] âš ï¸ åç«¯æ£€æµ‹åˆ° scanId å·²å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œè·³è¿‡:",
                  scanId
                );
                addDebugLog(
                  `Backend detected duplicate scanId ${scanId}, skipped`,
                  "warn"
                );
                // å³ä½¿åç«¯è·³è¿‡ï¼Œä¹Ÿä¿æŒ sentScanIds æ ‡è®°ï¼Œé˜²æ­¢é‡å¤æäº¤
              } else {
                // å‘é€æˆåŠŸï¼Œæ ‡è®°æ‰«æå®Œæˆ
                console.log("[Volumental] âœ… æ‰«æä¼šè¯å®Œæˆ");
              }

              isScanInProgress = false;
            })
            .catch((err) => {
              console.warn(
                "[Volumental] âš ï¸ CORS æ¨¡å¼å¤±è´¥ï¼Œå°è¯• no-cors æ¨¡å¼:",
                err
              );
              addDebugLog(
                `CORS failed, trying no-cors mode: ${err.message || err}`,
                "warn"
              );

              // é™çº§åˆ° no-cors æ¨¡å¼
              // æ³¨æ„ï¼šno-cors æ¨¡å¼ä¸‹æ— æ³•è¯»å–å“åº”ï¼Œä½†è¯·æ±‚åº”è¯¥èƒ½å‘é€
              fetch(LOG_ENDPOINT, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              })
                .then((noCorsRes) => {
                  console.log(
                    "[Volumental] âš ï¸ ä½¿ç”¨ no-cors æ¨¡å¼å‘é€ï¼ˆæ— æ³•ç¡®è®¤æ˜¯å¦æˆåŠŸï¼Œä½†æ•°æ®å¯èƒ½å·²é€è¾¾ï¼‰"
                  );
                  addDebugLog(
                    "Data sent via no-cors mode (cannot verify success)",
                    "warn"
                  );
                  // no-cors æ¨¡å¼ä¸‹æ— æ³•ç¡®è®¤ï¼Œä½†é€šå¸¸æ•°æ®å·²é€è¾¾ï¼Œæ ‡è®°æ‰«æå®Œæˆ
                  isScanInProgress = false;

                  // æç¤ºç”¨æˆ·æ£€æŸ¥åç«¯
                  console.warn(
                    "[Volumental] âš ï¸ æ³¨æ„ï¼šç”±äº CORS é™åˆ¶ï¼Œæ— æ³•ç¡®è®¤æ•°æ®æ˜¯å¦æˆåŠŸä¿å­˜ã€‚è¯·æ£€æŸ¥ Google Sheet ç¡®è®¤æ•°æ®æ˜¯å¦å·²è®°å½•ã€‚"
                  );
                  addDebugLog(
                    "âš ï¸ Cannot verify if data was saved. Please check Google Sheet.",
                    "warn"
                  );
                })
                .catch((e2) => {
                  console.error("[Volumental] âŒ no-cors æ¨¡å¼ä¹Ÿå¤±è´¥:", e2);
                  addDebugLog(
                    `no-cors mode also failed: ${e2.message || e2}`,
                    "error"
                  );
                  // å‘é€å®Œå…¨å¤±è´¥ï¼Œç§»é™¤æ ‡è®°ï¼Œå…è®¸é‡è¯•
                  sentScanIds.delete(scanId);
                  isScanInProgress = false;
                  currentScanSessionId = null;
                  console.log(
                    "[Volumental] å·²ç§»é™¤ scanId æ ‡è®°ï¼Œå…è®¸é‡è¯•:",
                    scanId
                  );
                });
            });
        });

        console.log("[Volumental] âœ… æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®å®Œæˆ");
      });

      // è¶…æ—¶æ£€æŸ¥
      setTimeout(() => {
        if (!window.Volumental) {
          console.error("[Volumental] âŒ SDK åœ¨ 5 ç§’åä»æœªåŠ è½½ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜");
        }
      }, 5000);
    </script>

    <noscript>éœ€è¦å¯ç”¨ JavaScript æ‰èƒ½è¿›è¡Œæ‰«æã€‚</noscript>
  </body>
</html>
