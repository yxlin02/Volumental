<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Foot Measurement</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family: -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial,
          "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
          sans-serif;
        background: #fff;
      }
      .wrap {
        max-width: 600px;
        margin: 0 auto;
        padding: 24px 16px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .email-form {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
      }
      .email-form label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
        font-size: 16px;
      }
      .email-form input {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .email-form .note {
        margin-top: 8px;
        font-size: 14px;
        color: #666;
      }
      .scan-button-container {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- Volumental Measurement Widget -->

    <div class="wrap">
      <h2 style="margin-top: 0; text-align: center">Foot Measurement</h2>

      <div class="email-form">
        <label for="emailInput">Email Address *</label>
        <input
          type="email"
          id="emailInput"
          placeholder="your.email@example.com"
          required
        />
        <div class="note">
          Please enter your email to start the measurement.
        </div>
      </div>

      <div class="scan-button-container">
        <volumental-measurement
          id="volumental-widget"
          variant="outline"
          measurement-on-widget="true"
        ></volumental-measurement>
      </div>
    </div>

    <script>
      const LOG_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbzNSJAJ6JAO2Cx8m3wzev0DYXWYcXrUyIVMdSbW6BOiB4LP46BW5Rsyut9qT_qn9zE0/exec";
      const SDK_URL = "https://js.volumental.com/sdk/v1/volumental.js";
      const CLIENT_ID = "f5b24fb9-1881-4998-a641-9f840056dcdd";

      console.log("[Volumental] å¼€å§‹åŠ è½½ SDK...", { SDK_URL, CLIENT_ID });

      // é˜²é‡å¤æäº¤ï¼šè®°å½•å·²å‘é€çš„ scanId
      const sentScanIds = new Set();
      let isListenerSetup = false;

      // è·å– email çš„è¾…åŠ©å‡½æ•°ï¼ˆä»å¤šä¸ªæ¥æºè·å–ï¼‰
      function getEmail() {
        // 1. ä» email è¾“å…¥æ¡†è·å–ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
        const emailInput = document.getElementById("emailInput");
        if (emailInput && emailInput.value.trim()) {
          const email = emailInput.value.trim();
          console.log("[Volumental] ä»è¾“å…¥æ¡†è·å– email:", email);
          return email;
        }

        // 2. ä» URL å‚æ•°è·å–
        const urlParams = new URLSearchParams(window.location.search);
        const urlEmail = urlParams.get("email");
        if (urlEmail) {
          console.log("[Volumental] ä» URL å‚æ•°è·å– email:", urlEmail);
          return urlEmail;
        }

        // 3. ä» localStorage è·å–
        const storedEmail = localStorage.getItem("volumental_email");
        if (storedEmail) {
          console.log("[Volumental] ä» localStorage è·å– email:", storedEmail);
          return storedEmail;
        }

        // 4. å¦‚æœéƒ½æ²¡æœ‰ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        console.log("[Volumental] æœªæ‰¾åˆ° emailï¼Œå°†ä½¿ç”¨ç©ºå€¼");
        return "";
      }

      // åŠ è½½ SDK
      (function loadSdk() {
        const s = document.createElement("script");
        s.async = true;
        s.src = SDK_URL;
        s.setAttribute("data-client-id", CLIENT_ID);
        s.onload = () => {
          console.log("[Volumental] SDK è„šæœ¬æ–‡ä»¶åŠ è½½æˆåŠŸ");
        };
        s.onerror = () => {
          console.error("[Volumental] SDK è„šæœ¬åŠ è½½å¤±è´¥");
        };
        document.body.appendChild(s);
      })();

      // ç­‰å¾… SDK åŠ è½½å®Œæˆåè®¾ç½®äº‹ä»¶ç›‘å¬ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
      window.addEventListener("volumental:on-loaded", () => {
        // é˜²æ­¢é‡å¤è®¾ç½®ç›‘å¬å™¨
        if (isListenerSetup) {
          console.warn("[Volumental] âš ï¸ äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®ï¼Œè·³è¿‡é‡å¤è®¾ç½®");
          return;
        }
        isListenerSetup = true;
        console.log("[Volumental] SDK åˆå§‹åŒ–å®Œæˆï¼Œwindow.Volumental å·²å¯ç”¨");

        // æ‰¾åˆ° widget å…ƒç´ 
        const element = document.getElementById("volumental-widget");
        if (!element) {
          console.error("[Volumental] âŒ æ‰¾ä¸åˆ° volumental-measurement å…ƒç´ ");
          return;
        }

        // è·å– emailï¼ˆä¸å†è®¾ç½® subjectï¼Œæ ¹æ®æ–‡æ¡£é»˜è®¤æ˜¯ undefinedï¼‰
        const email = getEmail();

        console.log("[Volumental] âœ… æ‰¾åˆ° widget å…ƒç´ ï¼Œå¼€å§‹è®¾ç½®äº‹ä»¶ç›‘å¬å™¨");

        // ç›‘å¬ widget æ‰“å¼€äº‹ä»¶
        element.addEventListener("volumental:on-opened", () => {
          console.log("[Volumental] ğŸ“± æ‰«æç•Œé¢å·²æ‰“å¼€");
        });

        // ç›‘å¬ widget å…³é—­äº‹ä»¶
        element.addEventListener("volumental:on-closed", () => {
          console.log("[Volumental] ğŸ“± æ‰«æç•Œé¢å·²å…³é—­");
        });

        // ç›‘å¬é”™è¯¯äº‹ä»¶
        element.addEventListener("volumental:on-error", (e) => {
          console.error(
            "[Volumental] âŒ æ‰«æé”™è¯¯:",
            e.detail?.message || "æœªçŸ¥é”™è¯¯"
          );
        });

        // æ ¹æ®æ–‡æ¡£ï¼Œåœ¨å…ƒç´ ä¸Šä½¿ç”¨ addEventListener ç›‘å¬äº‹ä»¶
        element.addEventListener("volumental:on-measurement", (e) => {
          console.log("[Volumental] âœ… æ‰«æå®Œæˆï¼äº‹ä»¶å·²è§¦å‘", e.detail);

          // æ ¹æ®æ–‡æ¡£ï¼Œæ•°æ®åœ¨ e.detail ä¸­ï¼ŒåŒ…å« { id } å­—æ®µ
          const scanId = e.detail?.id || "";

          // é˜²é‡å¤æäº¤ï¼šå¦‚æœè¿™ä¸ª scanId å·²ç»å‘é€è¿‡ï¼Œè·³è¿‡
          if (!scanId) {
            console.warn("[Volumental] âš ï¸ scanId ä¸ºç©ºï¼Œè·³è¿‡å‘é€");
            return;
          }

          if (sentScanIds.has(scanId)) {
            console.warn(
              "[Volumental] âš ï¸ scanId å·²å‘é€è¿‡ï¼Œè·³è¿‡é‡å¤æäº¤:",
              scanId
            );
            return;
          }

          // å¼ºåˆ¶ä»è¾“å…¥æ¡†è·å–æœ€æ–°çš„ email å€¼ï¼ˆç¡®ä¿è·å–åˆ°ç”¨æˆ·æœ€æ–°è¾“å…¥çš„å€¼ï¼‰
          const emailInput = document.getElementById("emailInput");
          let email = "";
          
          // ä¼˜å…ˆä»è¾“å…¥æ¡†è·å–ï¼ˆå®æ—¶å€¼ï¼‰
          if (emailInput && emailInput.value) {
            email = emailInput.value.trim();
            console.log("[Volumental] ä»è¾“å…¥æ¡†è·å– emailï¼ˆå®æ—¶å€¼ï¼‰:", email);
          } else {
            // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œå°è¯•ä»å…¶ä»–æ¥æºè·å–
            email = getEmail();
            console.log("[Volumental] ä»å…¶ä»–æ¥æºè·å– email:", email);
          }

          // éªŒè¯ email æ˜¯å¦æœ‰æ•ˆ
          if (!email) {
            console.warn("[Volumental] âš ï¸ Email ä¸ºç©ºï¼è¯·ç¡®ä¿å·²å¡«å†™ email åœ°å€");
            // å³ä½¿ email ä¸ºç©ºï¼Œä¹Ÿç»§ç»­å‘é€æ•°æ®ï¼ˆè®©åç«¯å¤„ç†ï¼‰
          } else {
            // ç®€å•çš„ email æ ¼å¼éªŒè¯
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(email)) {
              console.warn("[Volumental] âš ï¸ Email æ ¼å¼å¯èƒ½ä¸æ­£ç¡®:", email);
            }
          }

          console.log("[Volumental] æå–çš„æ•°æ®:", { scanId, email });

          const payload = {
            email: email || "", // ç¡®ä¿ email å­—æ®µå­˜åœ¨ï¼Œå³ä½¿ä¸ºç©º
            scanId: scanId,
            userAgent: navigator.userAgent,
            locale: navigator.language || "",
            extra: e.detail || {},
          };

          console.log("[Volumental] ğŸ“¤ å‡†å¤‡å‘é€æ•°æ®åˆ° Apps Script");
          console.log("[Volumental] å®Œæ•´ payload:", JSON.stringify(payload, null, 2));
          console.log("[Volumental] Email å­—æ®µå€¼:", payload.email);
          console.log("[Volumental] Email å­—æ®µç±»å‹:", typeof payload.email);
          console.log("[Volumental] Email å­—æ®µé•¿åº¦:", payload.email ? payload.email.length : 0);
          console.log("[Volumental] Email æ˜¯å¦ä¸ºç©º:", !payload.email || payload.email === "");
          console.log("[Volumental] ç›®æ ‡ URL:", LOG_ENDPOINT);

          // éªŒè¯ payload ä¸­çš„ email å­—æ®µ
          const payloadString = JSON.stringify(payload);
          console.log("[Volumental] åºåˆ—åŒ–åçš„ JSON å­—ç¬¦ä¸²:", payloadString);
          console.log("[Volumental] JSON ä¸­æ˜¯å¦åŒ…å« email å­—æ®µ:", payloadString.includes('"email"'));
          
          // å†æ¬¡éªŒè¯ email è¾“å…¥æ¡†çš„å€¼ï¼ˆå‘é€å‰æœ€åä¸€æ¬¡æ£€æŸ¥ï¼‰
          const finalEmailCheck = emailInput ? emailInput.value.trim() : "";
          if (finalEmailCheck && finalEmailCheck !== payload.email) {
            console.warn("[Volumental] âš ï¸ è­¦å‘Šï¼šè¾“å…¥æ¡†çš„ email å€¼ä¸ payload ä¸­çš„ä¸ä¸€è‡´ï¼");
            console.warn("[Volumental] è¾“å…¥æ¡†å€¼:", finalEmailCheck);
            console.warn("[Volumental] Payload å€¼:", payload.email);
            // æ›´æ–° payload ä¸­çš„ email
            payload.email = finalEmailCheck;
            console.log("[Volumental] å·²æ›´æ–° payload ä¸­çš„ email ä¸ºè¾“å…¥æ¡†çš„æœ€æ–°å€¼");
          }

          // æ ‡è®°ä¸ºå·²å‘é€ï¼ˆåœ¨å‘é€å‰æ ‡è®°ï¼Œé˜²æ­¢å¹¶å‘è¯·æ±‚ï¼‰
          sentScanIds.add(scanId);

          // å‘é€æ•°æ®åˆ° Apps Script
          fetch(LOG_ENDPOINT, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => {
              console.log("[Volumental] ğŸ“¥ æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :", res.status);
              return res.json();
            })
            .then((result) => {
              console.log(
                "[Volumental] âœ… æ•°æ®å‘é€æˆåŠŸï¼Apps Script å“åº”:",
                result
              );
              // å‘é€æˆåŠŸï¼Œä¿æŒæ ‡è®°ï¼ˆé˜²æ­¢é‡å¤ï¼‰
            })
            .catch((err) => {
              console.warn(
                "[Volumental] âš ï¸ CORS æ¨¡å¼å¤±è´¥ï¼Œå°è¯• no-cors æ¨¡å¼:",
                err
              );
              // é™çº§åˆ° no-cors æ¨¡å¼
              fetch(LOG_ENDPOINT, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              })
                .then(() => {
                  console.log(
                    "[Volumental] âš ï¸ ä½¿ç”¨ no-cors æ¨¡å¼å‘é€ï¼ˆæ— æ³•ç¡®è®¤æ˜¯å¦æˆåŠŸï¼Œä½†æ•°æ®å¯èƒ½å·²é€è¾¾ï¼‰"
                  );
                  // no-cors æ¨¡å¼ä¸‹æ— æ³•ç¡®è®¤ï¼Œä½†é€šå¸¸æ•°æ®å·²é€è¾¾ï¼Œä¿æŒæ ‡è®°
                })
                .catch((e2) => {
                  console.error("[Volumental] âŒ å‘é€å¤±è´¥:", e2);
                  // å‘é€å®Œå…¨å¤±è´¥ï¼Œç§»é™¤æ ‡è®°ï¼Œå…è®¸é‡è¯•
                  sentScanIds.delete(scanId);
                  console.log(
                    "[Volumental] å·²ç§»é™¤ scanId æ ‡è®°ï¼Œå…è®¸é‡è¯•:",
                    scanId
                  );
                });
            });
        });

        console.log("[Volumental] âœ… æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®å®Œæˆ");
      });

      // è¶…æ—¶æ£€æŸ¥
      setTimeout(() => {
        if (!window.Volumental) {
          console.error("[Volumental] âŒ SDK åœ¨ 5 ç§’åä»æœªåŠ è½½ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜");
        }
      }, 5000);
    </script>

    <noscript>éœ€è¦å¯ç”¨ JavaScript æ‰èƒ½è¿›è¡Œæ‰«æã€‚</noscript>
  </body>
</html>
