<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Volumental Collector (Minimal)</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family: -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial,
          "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
          sans-serif;
        background: #fff;
      }
      .wrap {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
      }
      volumental-measurement-embedded {
        display: block;
        min-height: 560px; /* å ä½ï¼Œç¡®ä¿å¯è§ */
        width: 100%;
        border: 1px solid #eee;
        border-radius: 8px;
      }
      .note {
        color: #666;
        font-size: 14px;
        margin: 8px 0;
      }
      .debug-box {
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 12px;
        margin: 12px 0;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        word-break: break-all;
      }
      .debug-box h4 {
        margin: 0 0 8px 0;
        font-size: 14px;
        color: #333;
      }
      .debug-item {
        margin: 4px 0;
        padding: 4px;
        background: #fff;
        border-left: 3px solid #0066cc;
      }
      .email-form {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
      }
      .email-form label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
      }
      .email-form input {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .email-form .note {
        margin-top: 8px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <!-- åªä¿ç•™ SDK ä¸å†…åµŒæ‰«æå™¨ï¼Œå°½é‡æ¥è¿‘å®˜æ–¹ collector é¡µé¢ã€‚æ”¹ä¸ºåŠ¨æ€æ³¨å…¥ä»¥æ•è· onerror/onloadã€‚ -->

    <div class="wrap">
      <h2 style="margin-top: 0;">Foot Measurement</h2>
      
      <div class="email-form">
        <label for="emailInput">Email Address *</label>
        <input
          type="email"
          id="emailInput"
          placeholder="your.email@example.com"
          required
        />
        <div class="note">Please enter your email to start the measurement.</div>
      </div>
      
      <div class="note" id="sdkStatus">Loading Volumental SDKâ€¦</div>
      <div class="note" id="elementStatus"></div>
      <div class="note" id="eventStatus" style="color: #0066cc; font-weight: bold;"></div>
      
      <div class="debug-box" id="debugBox" style="display: none;">
        <h4>è°ƒè¯•ä¿¡æ¯ï¼ˆæ‰‹æœºç«¯å¯è§ï¼‰</h4>
        <div id="debugContent"></div>
      </div>
      
      <volumental-measurement
        id="vmBtn"
        variant="outline"
        measurement-on-widget="true"
      ></volumental-measurement>
      <volumental-measurement-embedded
        id="vm"
      ></volumental-measurement-embedded>
    </div>

    <script>
      const LOG_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbzNSJAJ6JAO2Cx8m3wzev0DYXWYcXrUyIVMdSbW6BOiB4LP46BW5Rsyut9qT_qn9zE0/exec";
      const SDK_URL = "https://js.volumental.com/sdk/v1/volumental.js";
      const CLIENT_ID = "f5b24fb9-1881-4998-a641-9f840056dcdd";

      // è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºå‡½æ•°ï¼ˆæ‰‹æœºç«¯å¯è§ï¼‰
      function addDebugInfo(message, data = null) {
        const debugBox = document.getElementById("debugBox");
        const debugContent = document.getElementById("debugContent");
        if (!debugBox || !debugContent) return;

        debugBox.style.display = "block";
        const time = new Date().toLocaleTimeString();
        const item = document.createElement("div");
        item.className = "debug-item";
        item.innerHTML = `<strong>[${time}]</strong> ${message}`;
        if (data) {
          const dataStr = typeof data === "object" ? JSON.stringify(data, null, 2) : String(data);
          item.innerHTML += `<pre style="margin: 4px 0; font-size: 11px; white-space: pre-wrap;">${dataStr}</pre>`;
        }
        debugContent.appendChild(item);
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        debugBox.scrollTop = debugBox.scrollHeight;
      }

      function onReady(fn) {
        if (window.Volumental) fn();
        else
          window.addEventListener("volumental:sdk-ready", fn, { once: true });
      }

      // åŠ¨æ€æ’å…¥ SDKï¼Œå¸¦é”™è¯¯å¤„ç†
      (function loadSdk() {
        const s = document.createElement("script");
        s.async = true;
        s.src = SDK_URL;
        s.setAttribute("data-client-id", CLIENT_ID);
        s.onload = () => {
          addDebugInfo("ğŸ“¥ SDK è„šæœ¬æ–‡ä»¶åŠ è½½æˆåŠŸï¼Œç­‰å¾…åˆå§‹åŒ–...");
          const statusEl = document.getElementById("sdkStatus");
          if (statusEl)
            statusEl.textContent = "SDK script loaded, waiting for initâ€¦";
        };
        s.onerror = () => {
          addDebugInfo("âŒ SDK è„šæœ¬åŠ è½½å¤±è´¥ï¼ˆå¯èƒ½è¢«ç½‘ç»œæˆ–ç­–ç•¥æ‹¦æˆªï¼‰");
          const statusEl = document.getElementById("sdkStatus");
          if (statusEl)
            statusEl.textContent = "SDK è„šæœ¬åŠ è½½å¤±è´¥ï¼ˆå¯èƒ½è¢«ç½‘ç»œæˆ–ç­–ç•¥æ‹¦æˆªï¼‰ã€‚";
        };
        document.body.appendChild(s);
      })();

      onReady(() => {
        addDebugInfo("âœ… SDK åˆå§‹åŒ–å®Œæˆ");
        const statusEl = document.getElementById("sdkStatus");
        if (statusEl) statusEl.textContent = "SDK loaded. You can scan now.";

        // æ˜¾ç¤ºç»„ä»¶æ³¨å†ŒçŠ¶æ€
        const elStatus = document.getElementById("elementStatus");
        const hasBtn = !!customElements.get("volumental-measurement");
        const hasEmbed = !!customElements.get(
          "volumental-measurement-embedded"
        );
        if (elStatus)
          elStatus.textContent = `components: button=${hasBtn}, embedded=${hasEmbed}`;
        addDebugInfo("ç»„ä»¶æ³¨å†ŒçŠ¶æ€", { button: hasBtn, embedded: hasEmbed });

        // è·å– widget å…ƒç´ å’Œ email è¾“å…¥æ¡†
        const vmBtn = document.getElementById("vmBtn");
        const vmEmbed = document.getElementById("vm");
        const emailInput = document.getElementById("emailInput");

        // å½“ç”¨æˆ·è¾“å…¥ email æ—¶ï¼Œæ›´æ–° widget çš„ subject å±æ€§
        function updateSubject() {
          const email = emailInput.value.trim();
          if (email) {
            if (vmBtn) vmBtn.setAttribute("subject", email);
            if (vmEmbed) vmEmbed.setAttribute("subject", email);
            addDebugInfo(`ğŸ“§ Email å·²è®¾ç½®: ${email}`);
          } else {
            if (vmBtn) vmBtn.removeAttribute("subject");
            if (vmEmbed) vmEmbed.removeAttribute("subject");
          }
        }

        // ç›‘å¬ email è¾“å…¥
        emailInput.addEventListener("input", updateSubject);
        emailInput.addEventListener("blur", updateSubject);
        
        // åˆå§‹åŒæ­¥ä¸€æ¬¡
        updateSubject();

        window.Volumental.on("volumental:on-measurement", (data) => {
          addDebugInfo("âœ… æ‰«æå®Œæˆï¼äº‹ä»¶å·²è§¦å‘", data);
          
          const eventStatusEl = document.getElementById("eventStatus");
          if (eventStatusEl) {
            eventStatusEl.textContent = "æ‰«æå®Œæˆï¼æ­£åœ¨å‘é€æ•°æ®åˆ°è¡¨æ ¼...";
          }

          // è·å– emailï¼ˆä»è¾“å…¥æ¡†æˆ–ä» data ä¸­ï¼‰
          const email = emailInput.value.trim() || data?.subject || "";
          const scanId = data?.scanId || data?.scan?.id || data?.id || "";
          
          const payload = {
            subject: email,
            scanId,
            userAgent: navigator.userAgent,
            locale: navigator.language || "",
            email: email, // å•ç‹¬å­˜å‚¨ email å­—æ®µ
            extra: data || {},
          };

          addDebugInfo("ğŸ“¤ å‡†å¤‡å‘é€æ•°æ®åˆ° Apps Script", payload);

          // ä½¿ç”¨ fetch å¹¶å°è¯•è¯»å–å“åº”ï¼ˆå¦‚æœ CORS å…è®¸ï¼‰
          fetch(LOG_ENDPOINT, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => {
              addDebugInfo(`ğŸ“¥ æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç : ${res.status}`);
              return res.json();
            })
            .then((result) => {
              addDebugInfo("âœ… æ•°æ®å‘é€æˆåŠŸï¼Apps Script å“åº”", result);
              if (eventStatusEl) {
                eventStatusEl.textContent = `âœ… æ•°æ®å·²å‘é€ï¼scanId: ${scanId}`;
                eventStatusEl.style.color = "#00aa00";
              }
            })
            .catch((err) => {
              addDebugInfo("âš ï¸ CORS æ¨¡å¼å¤±è´¥ï¼Œå°è¯• no-cors æ¨¡å¼", err.message || String(err));
              // é™çº§åˆ° no-cors æ¨¡å¼ï¼ˆæ— æ³•è¯»å–å“åº”ï¼Œä½†æ•°æ®å¯èƒ½å·²é€è¾¾ï¼‰
              fetch(LOG_ENDPOINT, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              }).then(() => {
                addDebugInfo("âš ï¸ ä½¿ç”¨ no-cors æ¨¡å¼å‘é€ï¼ˆæ— æ³•ç¡®è®¤æ˜¯å¦æˆåŠŸï¼‰", { scanId });
                if (eventStatusEl) {
                  eventStatusEl.textContent = `âš ï¸ æ•°æ®å·²å‘é€ï¼ˆno-corsæ¨¡å¼ï¼‰scanId: ${scanId}`;
                  eventStatusEl.style.color = "#ff8800";
                }
              }).catch((e2) => {
                addDebugInfo("âŒ å‘é€å¤±è´¥", e2.message || String(e2));
                if (eventStatusEl) {
                  eventStatusEl.textContent = "âŒ å‘é€å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹è°ƒè¯•ä¿¡æ¯";
                  eventStatusEl.style.color = "#cc0000";
                }
              });
            });
        });
      });

      // 3 ç§’ä»æœªåŠ è½½åˆ° SDKï¼Œæç¤ºç”¨æˆ·åˆ·æ–°/æˆ–åŸŸåæœªæˆæƒ
      setTimeout(() => {
        if (!window.Volumental) {
          const statusEl = document.getElementById("sdkStatus");
          if (statusEl)
            statusEl.textContent =
              "SDK æœªå®Œæˆåˆå§‹åŒ–ï¼šå¯èƒ½ 1) ç½‘ç»œé˜»æ–­ 2) ç«™ç‚¹åŸŸåæœªåœ¨ Volumental å®¢æˆ·ç«¯å…è®¸åˆ—è¡¨ 3) æµè§ˆå™¨é™åˆ¶ã€‚";
        }
      }, 3000);
    </script>

    <noscript>éœ€è¦å¯ç”¨ JavaScript æ‰èƒ½è¿›è¡Œæ‰«æã€‚</noscript>
  </body>
</html>
