<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Foot Measurement</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family: -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial,
          "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
          sans-serif;
        background: #fff;
      }
      .wrap {
        max-width: 600px;
        margin: 0 auto;
        padding: 24px 16px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .email-form {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
      }
      .email-form label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
        font-size: 16px;
      }
      .email-form input {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .email-form .note {
        margin-top: 8px;
        font-size: 14px;
        color: #666;
      }
      .email-form .error-message {
        margin-top: 8px;
        font-size: 14px;
        color: #d32f2f;
        display: none;
      }
      .email-form .error-message.show {
        display: block;
      }
      .scan-button-container {
        text-align: center;
        position: relative;
      }
      .scan-button-container.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .scan-button-container .disabled-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        font-size: 14px;
        color: #666;
        z-index: 10;
      }
      .scan-button-container.disabled .disabled-overlay {
        display: flex;
      }
      /* è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ */
      #debug-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-height: 40vh;
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: "Courier New", monospace;
        font-size: 12px;
        padding: 12px;
        overflow-y: auto;
        z-index: 10000;
        border-top: 2px solid #007acc;
        display: none; /* é»˜è®¤éšè—ï¼Œå¯ä»¥é€šè¿‡æŒ‰é’®åˆ‡æ¢ */
      }
      #debug-panel.show {
        display: block;
      }
      #debug-panel .debug-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #444;
      }
      #debug-panel .debug-title {
        font-weight: bold;
        color: #4ec9b0;
        font-size: 14px;
      }
      #debug-panel .debug-controls {
        display: flex;
        gap: 8px;
      }
      #debug-panel button {
        background: #007acc;
        color: white;
        border: none;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
      }
      #debug-panel button:hover {
        background: #005a9e;
      }
      #debug-panel .debug-content {
        max-height: calc(40vh - 60px);
        overflow-y: auto;
      }
      #debug-panel .debug-log {
        margin: 4px 0;
        padding: 4px 8px;
        border-left: 3px solid transparent;
        word-wrap: break-word;
        white-space: pre-wrap;
      }
      #debug-panel .debug-log.log {
        border-left-color: #4ec9b0;
      }
      #debug-panel .debug-log.warn {
        border-left-color: #dcdcaa;
        background: rgba(220, 220, 170, 0.1);
      }
      #debug-panel .debug-log.error {
        border-left-color: #f48771;
        background: rgba(244, 135, 113, 0.1);
      }
      #debug-toggle {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: #007acc;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        z-index: 10001;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      #debug-toggle:hover {
        background: #005a9e;
      }
    </style>
  </head>
  <body>
    <!-- Volumental Measurement Widget -->

    <div class="wrap">
      <h2 style="margin-top: 0; text-align: center">Foot Measurement</h2>

      <div class="email-form">
        <label for="emailInput">Email Address *</label>
        <input
          type="email"
          id="emailInput"
          name="email-address"
          placeholder="your.email@example.com"
          required
          autocomplete="new-password"
          data-lpignore="true"
          data-form-type="other"
        />
        <div class="note">
          Please enter your email to start the measurement.
        </div>
        <div class="error-message" id="emailError">
          Please enter a valid email address to start scanning.
        </div>
      </div>

      <div class="scan-button-container" id="scanButtonContainer">
        <div class="disabled-overlay">
          Please enter your email address first
        </div>
        <volumental-measurement
          id="volumental-widget"
          variant="outline"
          measurement-on-widget="true"
        ></volumental-measurement>
      </div>
    </div>

    <!-- è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
    <button id="debug-toggle">ğŸ” Debug</button>
    <div id="debug-panel">
      <div class="debug-header">
        <div class="debug-title">ğŸ“± Debug Console</div>
        <div class="debug-controls">
          <button onclick="clearDebugLog()">Clear</button>
          <button onclick="toggleDebugPanel()">Hide</button>
        </div>
      </div>
      <div class="debug-content" id="debug-content"></div>
    </div>

    <script>
      // è°ƒè¯•é¢æ¿åŠŸèƒ½
      function addDebugLog(message, type = "log") {
        const debugContent = document.getElementById("debug-content");
        const logDiv = document.createElement("div");
        logDiv.className = `debug-log ${type}`;

        const timestamp = new Date().toLocaleTimeString();
        const prefix = type === "error" ? "âŒ" : type === "warn" ? "âš ï¸" : "â„¹ï¸";
        logDiv.textContent = `[${timestamp}] ${prefix} ${message}`;

        debugContent.appendChild(logDiv);
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        debugContent.scrollTop = debugContent.scrollHeight;

        // é™åˆ¶æ—¥å¿—æ•°é‡ï¼Œé¿å…å†…å­˜é—®é¢˜
        const maxLogs = 200;
        while (debugContent.children.length > maxLogs) {
          debugContent.removeChild(debugContent.firstChild);
        }
      }

      function clearDebugLog() {
        document.getElementById("debug-content").innerHTML = "";
        addDebugLog("Debug log cleared", "log");
      }

      function toggleDebugPanel() {
        const panel = document.getElementById("debug-panel");
        panel.classList.toggle("show");
        const button = document.getElementById("debug-toggle");
        button.textContent = panel.classList.contains("show")
          ? "ğŸ” Hide"
          : "ğŸ” Debug";
      }

      // åˆå§‹åŒ–è°ƒè¯•é¢æ¿
      document
        .getElementById("debug-toggle")
        .addEventListener("click", toggleDebugPanel);

      // æ‹¦æˆª console æ–¹æ³•
      const originalLog = console.log;
      const originalWarn = console.warn;
      const originalError = console.error;

      console.log = function (...args) {
        originalLog.apply(console, args);
        const message = args
          .map((arg) => {
            if (typeof arg === "object") {
              try {
                return JSON.stringify(arg, null, 2);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          })
          .join(" ");
        addDebugLog(message, "log");
      };

      console.warn = function (...args) {
        originalWarn.apply(console, args);
        const message = args
          .map((arg) => {
            if (typeof arg === "object") {
              try {
                return JSON.stringify(arg, null, 2);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          })
          .join(" ");
        addDebugLog(message, "warn");
      };

      console.error = function (...args) {
        originalError.apply(console, args);
        const message = args
          .map((arg) => {
            if (typeof arg === "object") {
              try {
                return JSON.stringify(arg, null, 2);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          })
          .join(" ");
        addDebugLog(message, "error");
      };

      // é¡µé¢åŠ è½½å®Œæˆæç¤º
      addDebugLog("Debug console initialized", "log");

      // ç¡®ä¿ email è¾“å…¥æ¡†å§‹ç»ˆä¸ºç©ºï¼Œé˜²æ­¢æµè§ˆå™¨è‡ªåŠ¨å¡«å……
      function clearEmailInput() {
        const emailInput = document.getElementById("emailInput");
        if (emailInput) {
          emailInput.value = "";
          emailInput.setAttribute("autocomplete", "new-password");
          addDebugLog("Email input cleared", "log");
        }
      }

      // é˜²æ­¢è‡ªåŠ¨å¡«å……çš„æŠ€å·§ï¼šçŸ­æš‚è®¾ç½®ä¸º readonlyï¼Œç„¶åç§»é™¤
      function preventAutofill() {
        const emailInput = document.getElementById("emailInput");
        if (emailInput) {
          // è®¾ç½®ä¸º readonly å¯ä»¥é˜²æ­¢æŸäº›æµè§ˆå™¨çš„è‡ªåŠ¨å¡«å……
          emailInput.setAttribute("readonly", "readonly");
          emailInput.value = "";

          // å»¶è¿Ÿç§»é™¤ readonlyï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿè¾“å…¥
          setTimeout(function () {
            emailInput.removeAttribute("readonly");
            emailInput.focus();
            emailInput.blur(); // ç§»é™¤ç„¦ç‚¹ï¼Œé˜²æ­¢è‡ªåŠ¨å¡«å……
            addDebugLog("Autofill prevention applied", "log");
          }, 100);
        }
      }

      // é¡µé¢åŠ è½½æ—¶æ¸…ç©ºå¹¶é˜²æ­¢è‡ªåŠ¨å¡«å……
      function initEmailInput() {
        clearEmailInput();
        // å»¶è¿Ÿæ‰§è¡Œé˜²æ­¢è‡ªåŠ¨å¡«å……ï¼Œç¡®ä¿åœ¨æµè§ˆå™¨å°è¯•è‡ªåŠ¨å¡«å……ä¹‹å
        setTimeout(preventAutofill, 200);
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initEmailInput);
      } else {
        initEmailInput();
      }

      // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“é¡µé¢é‡æ–°æ˜¾ç¤ºæ—¶æ¸…ç©ºï¼ˆé˜²æ­¢æŸäº›æµè§ˆå™¨çš„è‡ªåŠ¨å¡«å……ï¼‰
      document.addEventListener("visibilitychange", function () {
        if (!document.hidden) {
          setTimeout(clearEmailInput, 100);
        }
      });

      // ç›‘å¬è¾“å…¥æ¡†çš„è‡ªåŠ¨å¡«å……äº‹ä»¶
      const emailInput = document.getElementById("emailInput");
      if (emailInput) {
        // ç›‘å¬ autocomplete äº‹ä»¶ï¼ˆæŸäº›æµè§ˆå™¨ä¼šè§¦å‘ï¼‰
        emailInput.addEventListener("autocomplete", function (e) {
          addDebugLog("Autocomplete detected, clearing input", "warn");
          clearEmailInput();
        });

        // åœ¨è·å¾—ç„¦ç‚¹æ—¶æ£€æŸ¥å¹¶æ¸…ç©ºï¼ˆæŸäº›æµè§ˆå™¨ä¼šåœ¨ç„¦ç‚¹æ—¶è‡ªåŠ¨å¡«å……ï¼‰
        let focusTimeout;
        emailInput.addEventListener("focus", function (e) {
          // å»¶è¿Ÿæ£€æŸ¥ï¼Œå› ä¸ºè‡ªåŠ¨å¡«å……å¯èƒ½åœ¨ç„¦ç‚¹äº‹ä»¶ä¹‹åå‘ç”Ÿ
          focusTimeout = setTimeout(function () {
            const value = emailInput.value;
            // å¦‚æœè¾“å…¥æ¡†åœ¨è·å¾—ç„¦ç‚¹åç«‹å³æœ‰å€¼ï¼ˆå¯èƒ½æ˜¯è‡ªåŠ¨å¡«å……ï¼‰ï¼Œæ¸…ç©ºå®ƒ
            // ä½†åªæœ‰åœ¨ç”¨æˆ·è¿˜æ²¡æœ‰å¼€å§‹è¾“å…¥çš„æƒ…å†µä¸‹
            if (value && !emailInput.matches(":focus")) {
              addDebugLog("Detected autofill on focus, clearing", "warn");
              clearEmailInput();
            }
          }, 50);
        });

        emailInput.addEventListener("blur", function (e) {
          if (focusTimeout) {
            clearTimeout(focusTimeout);
          }
        });
      }

      const LOG_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbzNSJAJ6JAO2Cx8m3wzev0DYXWYcXrUyIVMdSbW6BOiB4LP46BW5Rsyut9qT_qn9zE0/exec";
      const SDK_URL = "https://js.volumental.com/sdk/v1/volumental.js";
      const CLIENT_ID = "f5b24fb9-1881-4998-a641-9f840056dcdd";

      console.log("[Volumental] å¼€å§‹åŠ è½½ SDK...", { SDK_URL, CLIENT_ID });

      // é˜²é‡å¤æäº¤ï¼šè®°å½•å·²å‘é€çš„ scanId
      const sentScanIds = new Set();
      let isListenerSetup = false;

      // è·å– email çš„è¾…åŠ©å‡½æ•°ï¼ˆä»å¤šä¸ªæ¥æºè·å–ï¼‰
      function getEmail() {
        // 1. ä» email è¾“å…¥æ¡†è·å–ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
        const emailInput = document.getElementById("emailInput");
        if (emailInput && emailInput.value.trim()) {
          const email = emailInput.value.trim();
          console.log("[Volumental] ä»è¾“å…¥æ¡†è·å– email:", email);
          return email;
        }

        // 2. ä» URL å‚æ•°è·å–
        const urlParams = new URLSearchParams(window.location.search);
        const urlEmail = urlParams.get("email");
        if (urlEmail) {
          console.log("[Volumental] ä» URL å‚æ•°è·å– email:", urlEmail);
          return urlEmail;
        }

        // 3. ä» localStorage è·å–
        const storedEmail = localStorage.getItem("volumental_email");
        if (storedEmail) {
          console.log("[Volumental] ä» localStorage è·å– email:", storedEmail);
          return storedEmail;
        }

        // 4. å¦‚æœéƒ½æ²¡æœ‰ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        console.log("[Volumental] æœªæ‰¾åˆ° emailï¼Œå°†ä½¿ç”¨ç©ºå€¼");
        return "";
      }

      // åŠ è½½ SDK
      (function loadSdk() {
        const s = document.createElement("script");
        s.async = true;
        s.src = SDK_URL;
        s.setAttribute("data-client-id", CLIENT_ID);
        s.onload = () => {
          console.log("[Volumental] SDK è„šæœ¬æ–‡ä»¶åŠ è½½æˆåŠŸ");
        };
        s.onerror = () => {
          console.error("[Volumental] SDK è„šæœ¬åŠ è½½å¤±è´¥");
        };
        document.body.appendChild(s);
      })();

      // ç­‰å¾… SDK åŠ è½½å®Œæˆåè®¾ç½®äº‹ä»¶ç›‘å¬ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
      window.addEventListener("volumental:on-loaded", () => {
        // é˜²æ­¢é‡å¤è®¾ç½®ç›‘å¬å™¨
        if (isListenerSetup) {
          console.warn("[Volumental] âš ï¸ äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®ï¼Œè·³è¿‡é‡å¤è®¾ç½®");
          return;
        }
        isListenerSetup = true;
        console.log("[Volumental] SDK åˆå§‹åŒ–å®Œæˆï¼Œwindow.Volumental å·²å¯ç”¨");

        // æ‰¾åˆ° widget å…ƒç´ 
        const element = document.getElementById("volumental-widget");
        if (!element) {
          console.error("[Volumental] âŒ æ‰¾ä¸åˆ° volumental-measurement å…ƒç´ ");
          return;
        }

        // è·å– emailï¼ˆä¸å†è®¾ç½® subjectï¼Œæ ¹æ®æ–‡æ¡£é»˜è®¤æ˜¯ undefinedï¼‰
        const email = getEmail();

        console.log("[Volumental] âœ… æ‰¾åˆ° widget å…ƒç´ ï¼Œå¼€å§‹è®¾ç½®äº‹ä»¶ç›‘å¬å™¨");

        // Email éªŒè¯å‡½æ•°
        function isValidEmail(email) {
          if (!email || typeof email !== "string") return false;
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailPattern.test(email.trim());
        }

        // æ›´æ–°æ‰«ææŒ‰é’®çŠ¶æ€
        function updateScanButtonState() {
          const emailInput = document.getElementById("emailInput");
          const scanButtonContainer = document.getElementById("scanButtonContainer");
          const emailError = document.getElementById("emailError");
          
          if (!emailInput || !scanButtonContainer) return;
          
          const email = emailInput.value ? emailInput.value.trim() : "";
          const isValid = isValidEmail(email);
          
          if (isValid) {
            scanButtonContainer.classList.remove("disabled");
            emailError.classList.remove("show");
            console.log("[Volumental] âœ… Email æœ‰æ•ˆï¼Œæ‰«ææŒ‰é’®å·²å¯ç”¨");
          } else {
            scanButtonContainer.classList.add("disabled");
            if (email.length > 0) {
              emailError.classList.add("show");
            } else {
              emailError.classList.remove("show");
            }
            console.log("[Volumental] âš ï¸ Email æ— æ•ˆæˆ–ä¸ºç©ºï¼Œæ‰«ææŒ‰é’®å·²ç¦ç”¨");
          }
        }

        // ç›‘å¬ email è¾“å…¥æ¡†å˜åŒ–
        const emailInput = document.getElementById("emailInput");
        if (emailInput) {
          emailInput.addEventListener("input", updateScanButtonState);
          emailInput.addEventListener("blur", updateScanButtonState);
          emailInput.addEventListener("change", updateScanButtonState);
        }

        // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        updateScanButtonState();

        // ç›‘å¬ widget æ‰“å¼€äº‹ä»¶ - åœ¨æ‰“å¼€æ—¶éªŒè¯ email
        element.addEventListener("volumental:on-opened", (e) => {
          console.log("[Volumental] ğŸ“± æ‰«æç•Œé¢å·²æ‰“å¼€");
          
          // å†æ¬¡éªŒè¯ email
          const emailInput = document.getElementById("emailInput");
          const email = emailInput ? emailInput.value.trim() : "";
          
          if (!isValidEmail(email)) {
            console.warn("[Volumental] âš ï¸ Email æ— æ•ˆï¼Œé˜»æ­¢æ‰«æ");
            addDebugLog("Email is required. Please enter your email address first.", "error");
            
            // æ˜¾ç¤ºé”™è¯¯æç¤º
            const emailError = document.getElementById("emailError");
            if (emailError) {
              emailError.classList.add("show");
              emailError.textContent = "Please enter a valid email address to start scanning.";
            }
            
            // æ»šåŠ¨åˆ° email è¾“å…¥æ¡†
            if (emailInput) {
              emailInput.scrollIntoView({ behavior: "smooth", block: "center" });
              emailInput.focus();
            }
            
            // æç¤ºç”¨æˆ·ï¼ˆä½¿ç”¨æ›´å‹å¥½çš„æ–¹å¼ï¼‰
            setTimeout(() => {
              // å°è¯•å…³é—­æ‰«æç•Œé¢ï¼ˆå¦‚æœ widget æ”¯æŒï¼‰
              // æ³¨æ„ï¼šè¿™å–å†³äº Volumental widget çš„å®ç°
              console.warn("[Volumental] âš ï¸ ç”±äº email æ— æ•ˆï¼Œè¯·å…ˆå¡«å†™ email åœ°å€");
            }, 100);
          }
        });

        // ç›‘å¬ widget å…³é—­äº‹ä»¶
        element.addEventListener("volumental:on-closed", () => {
          console.log("[Volumental] ğŸ“± æ‰«æç•Œé¢å·²å…³é—­");
        });

        // ç›‘å¬é”™è¯¯äº‹ä»¶
        element.addEventListener("volumental:on-error", (e) => {
          console.error(
            "[Volumental] âŒ æ‰«æé”™è¯¯:",
            e.detail?.message || "æœªçŸ¥é”™è¯¯"
          );
        });

        // æ ¹æ®æ–‡æ¡£ï¼Œåœ¨å…ƒç´ ä¸Šä½¿ç”¨ addEventListener ç›‘å¬äº‹ä»¶
        element.addEventListener("volumental:on-measurement", (e) => {
          console.log("[Volumental] âœ… æ‰«æå®Œæˆï¼äº‹ä»¶å·²è§¦å‘", e.detail);

          // æ ¹æ®æ–‡æ¡£ï¼Œæ•°æ®åœ¨ e.detail ä¸­ï¼ŒåŒ…å« { id } å­—æ®µ
          const scanId = e.detail?.id || "";

          // é˜²é‡å¤æäº¤ï¼šå¦‚æœè¿™ä¸ª scanId å·²ç»å‘é€è¿‡ï¼Œè·³è¿‡
          if (!scanId) {
            console.warn("[Volumental] âš ï¸ scanId ä¸ºç©ºï¼Œè·³è¿‡å‘é€");
            return;
          }

          if (sentScanIds.has(scanId)) {
            console.warn(
              "[Volumental] âš ï¸ scanId å·²å‘é€è¿‡ï¼Œè·³è¿‡é‡å¤æäº¤:",
              scanId
            );
            return;
          }

          // åœ¨å‘é€å‰å†æ¬¡éªŒè¯ email
          const emailInput = document.getElementById("emailInput");
          let email = emailInput ? emailInput.value.trim() : "";
          
          if (!isValidEmail(email)) {
            console.error("[Volumental] âŒ Email æ— æ•ˆï¼Œæ— æ³•å‘é€æ•°æ®");
            addDebugLog("Cannot send data: Email is required and must be valid.", "error");
            
            // æ˜¾ç¤ºé”™è¯¯æç¤º
            const emailError = document.getElementById("emailError");
            if (emailError) {
              emailError.classList.add("show");
              emailError.textContent = "Please enter a valid email address. Data was not sent.";
            }
            
            // æ»šåŠ¨åˆ° email è¾“å…¥æ¡†
            if (emailInput) {
              emailInput.scrollIntoView({ behavior: "smooth", block: "center" });
              emailInput.focus();
            }
            
            return; // ä¸å‘é€æ•°æ®
          }

          // å¼ºåˆ¶ä»è¾“å…¥æ¡†è·å–æœ€æ–°çš„ email å€¼ï¼ˆç¡®ä¿è·å–åˆ°ç”¨æˆ·æœ€æ–°è¾“å…¥çš„å€¼ï¼‰
          // email å˜é‡å·²åœ¨ä¸Šé¢å£°æ˜ï¼Œè¿™é‡Œé‡æ–°è·å–ç¡®ä¿æ˜¯æœ€æ–°å€¼
          email = emailInput ? emailInput.value.trim() : "";

          // ä¼˜å…ˆä»è¾“å…¥æ¡†è·å–ï¼ˆå®æ—¶å€¼ï¼‰- ä½¿ç”¨å¤šç§æ–¹å¼ç¡®ä¿è·å–åˆ°å€¼
          if (emailInput) {
            // æ–¹æ³•1: ç›´æ¥è¯»å– value
            email = emailInput.value ? emailInput.value.trim() : "";

            // æ–¹æ³•2: å¦‚æœ value ä¸ºç©ºï¼Œå°è¯•è¯»å–å…¶ä»–å±æ€§
            if (!email && emailInput.getAttribute) {
              const attrValue = emailInput.getAttribute("value");
              if (attrValue) {
                email = attrValue.trim();
                console.log("[Volumental] ä» input å±æ€§è·å– email:", email);
              }
            }

            // æ–¹æ³•3: å¦‚æœè¿˜æ˜¯ä¸ºç©ºï¼Œå°è¯•ä»å…¶ä»–æ¥æºè·å–
            if (!email) {
              email = getEmail();
              console.log("[Volumental] ä»å…¶ä»–æ¥æºè·å– email:", email);
            } else {
              console.log("[Volumental] ä»è¾“å…¥æ¡†è·å– emailï¼ˆå®æ—¶å€¼ï¼‰:", email);
            }
          } else {
            // å¦‚æœæ‰¾ä¸åˆ°è¾“å…¥æ¡†ï¼Œä½¿ç”¨ getEmail() å‡½æ•°
            email = getEmail();
            console.log(
              "[Volumental] æ‰¾ä¸åˆ°è¾“å…¥æ¡†ï¼Œä»å…¶ä»–æ¥æºè·å– email:",
              email
            );
          }

          // æœ€ç»ˆéªŒè¯ï¼šå¦‚æœ email è¿˜æ˜¯ä¸ºç©ºï¼Œå°è¯•å†æ¬¡ä»è¾“å…¥æ¡†è¯»å–
          if (!email && emailInput) {
            // å»¶è¿Ÿä¸€ç‚¹å†è¯»å–ï¼ˆæŸäº›æƒ…å†µä¸‹å€¼å¯èƒ½è¿˜æ²¡æ›´æ–°ï¼‰
            setTimeout(() => {
              const delayedEmail = emailInput.value
                ? emailInput.value.trim()
                : "";
              if (delayedEmail && !email) {
                console.warn("[Volumental] âš ï¸ å»¶è¿Ÿè¯»å–åˆ° email:", delayedEmail);
                // æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½æ›´æ–° emailï¼Œå› ä¸ºå·²ç»å‘é€äº†ï¼Œä½†å¯ä»¥è®°å½•æ—¥å¿—
              }
            }, 100);
          }

          // éªŒè¯ email æ˜¯å¦æœ‰æ•ˆ
          if (!email) {
            console.warn("[Volumental] âš ï¸ Email ä¸ºç©ºï¼è¯·ç¡®ä¿å·²å¡«å†™ email åœ°å€");
            // å³ä½¿ email ä¸ºç©ºï¼Œä¹Ÿç»§ç»­å‘é€æ•°æ®ï¼ˆè®©åç«¯å¤„ç†ï¼‰
          } else {
            // ç®€å•çš„ email æ ¼å¼éªŒè¯
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(email)) {
              console.warn("[Volumental] âš ï¸ Email æ ¼å¼å¯èƒ½ä¸æ­£ç¡®:", email);
            }
          }

          console.log("[Volumental] æå–çš„æ•°æ®:", { scanId, email });

          const payload = {
            email: email || "", // ç¡®ä¿ email å­—æ®µå­˜åœ¨ï¼Œå³ä½¿ä¸ºç©º
            scanId: scanId,
            userAgent: navigator.userAgent,
            locale: navigator.language || "",
            extra: e.detail || {},
          };

          console.log("[Volumental] ğŸ“¤ å‡†å¤‡å‘é€æ•°æ®åˆ° Apps Script");
          console.log(
            "[Volumental] å®Œæ•´ payload:",
            JSON.stringify(payload, null, 2)
          );
          console.log("[Volumental] Email å­—æ®µå€¼:", payload.email);
          console.log("[Volumental] Email å­—æ®µç±»å‹:", typeof payload.email);
          console.log(
            "[Volumental] Email å­—æ®µé•¿åº¦:",
            payload.email ? payload.email.length : 0
          );
          console.log(
            "[Volumental] Email æ˜¯å¦ä¸ºç©º:",
            !payload.email || payload.email === ""
          );
          console.log("[Volumental] ç›®æ ‡ URL:", LOG_ENDPOINT);

          // éªŒè¯ payload ä¸­çš„ email å­—æ®µ
          const payloadString = JSON.stringify(payload);
          console.log("[Volumental] åºåˆ—åŒ–åçš„ JSON å­—ç¬¦ä¸²:", payloadString);
          console.log(
            "[Volumental] JSON ä¸­æ˜¯å¦åŒ…å« email å­—æ®µ:",
            payloadString.includes('"email"')
          );

          // å†æ¬¡éªŒè¯ email è¾“å…¥æ¡†çš„å€¼ï¼ˆå‘é€å‰æœ€åä¸€æ¬¡æ£€æŸ¥ï¼‰
          const finalEmailCheck = emailInput ? emailInput.value.trim() : "";

          // å¦‚æœæœ€ç»ˆæ£€æŸ¥å‘ç° email ä¸ºç©ºï¼Œä½†ä¹‹å‰æœ‰å€¼ï¼Œä½¿ç”¨æœ€ç»ˆæ£€æŸ¥çš„å€¼
          if (!finalEmailCheck && payload.email) {
            console.warn(
              "[Volumental] âš ï¸ è­¦å‘Šï¼šæœ€ç»ˆæ£€æŸ¥æ—¶ email ä¸ºç©ºï¼Œä½† payload ä¸­æœ‰å€¼"
            );
          } else if (finalEmailCheck && finalEmailCheck !== payload.email) {
            console.warn(
              "[Volumental] âš ï¸ è­¦å‘Šï¼šè¾“å…¥æ¡†çš„ email å€¼ä¸ payload ä¸­çš„ä¸ä¸€è‡´ï¼"
            );
            console.warn("[Volumental] è¾“å…¥æ¡†å€¼:", finalEmailCheck);
            console.warn("[Volumental] Payload å€¼:", payload.email);
            // æ›´æ–° payload ä¸­çš„ email
            payload.email = finalEmailCheck;
            console.log(
              "[Volumental] å·²æ›´æ–° payload ä¸­çš„ email ä¸ºè¾“å…¥æ¡†çš„æœ€æ–°å€¼"
            );
          } else if (finalEmailCheck && !payload.email) {
            // å¦‚æœæœ€ç»ˆæ£€æŸ¥æœ‰å€¼ä½† payload ä¸­æ²¡æœ‰ï¼Œæ›´æ–° payload
            console.warn(
              "[Volumental] âš ï¸ è­¦å‘Šï¼šæœ€ç»ˆæ£€æŸ¥å‘ç° emailï¼Œä½† payload ä¸­ä¸ºç©ºï¼Œæ›´æ–° payload"
            );
            payload.email = finalEmailCheck;
          }

          // æœ€ç»ˆç¡®è®¤ email å€¼
          console.log("[Volumental] ğŸ“§ æœ€ç»ˆå‘é€çš„ email å€¼:", payload.email);
          console.log(
            "[Volumental] ğŸ“§ Email æ˜¯å¦ä¸ºç©º:",
            !payload.email || payload.email === ""
          );

          // æ ‡è®°ä¸ºå·²å‘é€ï¼ˆåœ¨å‘é€å‰æ ‡è®°ï¼Œé˜²æ­¢å¹¶å‘è¯·æ±‚ï¼‰
          sentScanIds.add(scanId);

          // å‘é€æ•°æ®åˆ° Apps Script
          fetch(LOG_ENDPOINT, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => {
              console.log("[Volumental] ğŸ“¥ æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :", res.status);
              return res.json();
            })
            .then((result) => {
              console.log(
                "[Volumental] âœ… æ•°æ®å‘é€æˆåŠŸï¼Apps Script å“åº”:",
                result
              );
              // å‘é€æˆåŠŸï¼Œä¿æŒæ ‡è®°ï¼ˆé˜²æ­¢é‡å¤ï¼‰
            })
            .catch((err) => {
              console.warn(
                "[Volumental] âš ï¸ CORS æ¨¡å¼å¤±è´¥ï¼Œå°è¯• no-cors æ¨¡å¼:",
                err
              );
              // é™çº§åˆ° no-cors æ¨¡å¼
              fetch(LOG_ENDPOINT, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              })
                .then(() => {
                  console.log(
                    "[Volumental] âš ï¸ ä½¿ç”¨ no-cors æ¨¡å¼å‘é€ï¼ˆæ— æ³•ç¡®è®¤æ˜¯å¦æˆåŠŸï¼Œä½†æ•°æ®å¯èƒ½å·²é€è¾¾ï¼‰"
                  );
                  // no-cors æ¨¡å¼ä¸‹æ— æ³•ç¡®è®¤ï¼Œä½†é€šå¸¸æ•°æ®å·²é€è¾¾ï¼Œä¿æŒæ ‡è®°
                })
                .catch((e2) => {
                  console.error("[Volumental] âŒ å‘é€å¤±è´¥:", e2);
                  // å‘é€å®Œå…¨å¤±è´¥ï¼Œç§»é™¤æ ‡è®°ï¼Œå…è®¸é‡è¯•
                  sentScanIds.delete(scanId);
                  console.log(
                    "[Volumental] å·²ç§»é™¤ scanId æ ‡è®°ï¼Œå…è®¸é‡è¯•:",
                    scanId
                  );
                });
            });
        });

        console.log("[Volumental] âœ… æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®å®Œæˆ");
      });

      // è¶…æ—¶æ£€æŸ¥
      setTimeout(() => {
        if (!window.Volumental) {
          console.error("[Volumental] âŒ SDK åœ¨ 5 ç§’åä»æœªåŠ è½½ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜");
        }
      }, 5000);
    </script>

    <noscript>éœ€è¦å¯ç”¨ JavaScript æ‰èƒ½è¿›è¡Œæ‰«æã€‚</noscript>
  </body>
</html>
