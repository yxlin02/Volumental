<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Foot Measurement</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family: -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial,
          "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
          sans-serif;
        background: #fff;
      }
      .wrap {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 16px;
      }
    </style>
  </head>
  <body>
    <!-- Volumental Measurement Widget -->

    <div class="wrap">
      <volumental-measurement
        id="volumental-widget"
        variant="outline"
        measurement-on-widget="true"
      ></volumental-measurement>
    </div>

    <script>
      const LOG_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbzNSJAJ6JAO2Cx8m3wzev0DYXWYcXrUyIVMdSbW6BOiB4LP46BW5Rsyut9qT_qn9zE0/exec";
      const SDK_URL = "https://js.volumental.com/sdk/v1/volumental.js";
      const CLIENT_ID = "f5b24fb9-1881-4998-a641-9f840056dcdd";

      console.log("[Volumental] å¼€å§‹åŠ è½½ SDK...", { SDK_URL, CLIENT_ID });

      // é˜²é‡å¤æäº¤ï¼šè®°å½•å·²å‘é€çš„ scanId
      const sentScanIds = new Set();
      let isListenerSetup = false;

      // åŠ è½½ SDK
      (function loadSdk() {
        const s = document.createElement("script");
        s.async = true;
        s.src = SDK_URL;
        s.setAttribute("data-client-id", CLIENT_ID);
        s.onload = () => {
          console.log("[Volumental] SDK è„šæœ¬æ–‡ä»¶åŠ è½½æˆåŠŸ");
        };
        s.onerror = () => {
          console.error("[Volumental] SDK è„šæœ¬åŠ è½½å¤±è´¥");
        };
        document.body.appendChild(s);
      })();

      // ç­‰å¾… SDK åŠ è½½å®Œæˆåè®¾ç½®äº‹ä»¶ç›‘å¬ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
      window.addEventListener("volumental:on-loaded", () => {
        // é˜²æ­¢é‡å¤è®¾ç½®ç›‘å¬å™¨
        if (isListenerSetup) {
          console.warn("[Volumental] âš ï¸ äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®ï¼Œè·³è¿‡é‡å¤è®¾ç½®");
          return;
        }
        isListenerSetup = true;
        console.log("[Volumental] SDK åˆå§‹åŒ–å®Œæˆï¼Œwindow.Volumental å·²å¯ç”¨");

        // æ‰¾åˆ° widget å…ƒç´ 
        const element = document.getElementById("volumental-widget");
        if (!element) {
          console.error("[Volumental] âŒ æ‰¾ä¸åˆ° volumental-measurement å…ƒç´ ");
          return;
        }

        console.log("[Volumental] âœ… æ‰¾åˆ° widget å…ƒç´ ï¼Œå¼€å§‹è®¾ç½®äº‹ä»¶ç›‘å¬å™¨");

        // ç›‘å¬ widget æ‰“å¼€äº‹ä»¶
        element.addEventListener("volumental:on-opened", () => {
          console.log("[Volumental] ğŸ“± æ‰«æç•Œé¢å·²æ‰“å¼€");
        });

        // ç›‘å¬ widget å…³é—­äº‹ä»¶
        element.addEventListener("volumental:on-closed", () => {
          console.log("[Volumental] ğŸ“± æ‰«æç•Œé¢å·²å…³é—­");
        });

        // ç›‘å¬é”™è¯¯äº‹ä»¶
        element.addEventListener("volumental:on-error", (e) => {
          console.error(
            "[Volumental] âŒ æ‰«æé”™è¯¯:",
            e.detail?.message || "æœªçŸ¥é”™è¯¯"
          );
        });

        // æ ¹æ®æ–‡æ¡£ï¼Œåœ¨å…ƒç´ ä¸Šä½¿ç”¨ addEventListener ç›‘å¬äº‹ä»¶
        element.addEventListener("volumental:on-measurement", (e) => {
          console.log("[Volumental] âœ… æ‰«æå®Œæˆï¼äº‹ä»¶å·²è§¦å‘", e.detail);

          // æ ¹æ®æ–‡æ¡£ï¼Œæ•°æ®åœ¨ e.detail ä¸­ï¼ŒåŒ…å« { id } å­—æ®µ
          const scanId = e.detail?.id || "";
          
          // é˜²é‡å¤æäº¤ï¼šå¦‚æœè¿™ä¸ª scanId å·²ç»å‘é€è¿‡ï¼Œè·³è¿‡
          if (!scanId) {
            console.warn("[Volumental] âš ï¸ scanId ä¸ºç©ºï¼Œè·³è¿‡å‘é€");
            return;
          }
          
          if (sentScanIds.has(scanId)) {
            console.warn(
              "[Volumental] âš ï¸ scanId å·²å‘é€è¿‡ï¼Œè·³è¿‡é‡å¤æäº¤:",
              scanId
            );
            return;
          }

          // ä» widget å…ƒç´ è·å– subject å±æ€§ï¼ˆå¦‚æœè®¾ç½®äº†ï¼‰
          const subject = element.getAttribute("subject") || "";

          console.log("[Volumental] æå–çš„æ•°æ®:", { scanId, subject });

          const payload = {
            subject: subject,
            scanId: scanId,
            userAgent: navigator.userAgent,
            locale: navigator.language || "",
            extra: e.detail || {},
          };

          console.log("[Volumental] ğŸ“¤ å‡†å¤‡å‘é€æ•°æ®åˆ° Apps Script:", payload);
          console.log("[Volumental] ç›®æ ‡ URL:", LOG_ENDPOINT);

          // æ ‡è®°ä¸ºå·²å‘é€ï¼ˆåœ¨å‘é€å‰æ ‡è®°ï¼Œé˜²æ­¢å¹¶å‘è¯·æ±‚ï¼‰
          sentScanIds.add(scanId);

          // å‘é€æ•°æ®åˆ° Apps Script
          fetch(LOG_ENDPOINT, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => {
              console.log("[Volumental] ğŸ“¥ æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :", res.status);
              return res.json();
            })
            .then((result) => {
              console.log(
                "[Volumental] âœ… æ•°æ®å‘é€æˆåŠŸï¼Apps Script å“åº”:",
                result
              );
              // å‘é€æˆåŠŸï¼Œä¿æŒæ ‡è®°ï¼ˆé˜²æ­¢é‡å¤ï¼‰
            })
            .catch((err) => {
              console.warn(
                "[Volumental] âš ï¸ CORS æ¨¡å¼å¤±è´¥ï¼Œå°è¯• no-cors æ¨¡å¼:",
                err
              );
              // é™çº§åˆ° no-cors æ¨¡å¼
              fetch(LOG_ENDPOINT, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              })
                .then(() => {
                  console.log(
                    "[Volumental] âš ï¸ ä½¿ç”¨ no-cors æ¨¡å¼å‘é€ï¼ˆæ— æ³•ç¡®è®¤æ˜¯å¦æˆåŠŸï¼Œä½†æ•°æ®å¯èƒ½å·²é€è¾¾ï¼‰"
                  );
                  // no-cors æ¨¡å¼ä¸‹æ— æ³•ç¡®è®¤ï¼Œä½†é€šå¸¸æ•°æ®å·²é€è¾¾ï¼Œä¿æŒæ ‡è®°
                })
                .catch((e2) => {
                  console.error("[Volumental] âŒ å‘é€å¤±è´¥:", e2);
                  // å‘é€å®Œå…¨å¤±è´¥ï¼Œç§»é™¤æ ‡è®°ï¼Œå…è®¸é‡è¯•
                  sentScanIds.delete(scanId);
                  console.log(
                    "[Volumental] å·²ç§»é™¤ scanId æ ‡è®°ï¼Œå…è®¸é‡è¯•:",
                    scanId
                  );
                });
            });
        });

        console.log("[Volumental] âœ… æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®å®Œæˆ");
      });

      // è¶…æ—¶æ£€æŸ¥
      setTimeout(() => {
        if (!window.Volumental) {
          console.error("[Volumental] âŒ SDK åœ¨ 5 ç§’åä»æœªåŠ è½½ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜");
        }
      }, 5000);
    </script>

    <noscript>éœ€è¦å¯ç”¨ JavaScript æ‰èƒ½è¿›è¡Œæ‰«æã€‚</noscript>
  </body>
</html>
